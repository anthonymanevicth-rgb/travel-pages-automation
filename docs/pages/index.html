<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{TITLE}}</title>

  <!-- Leaflet (no API key needed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220; --muted:#9fb0d0; --text:#eef3ff;
      --accent:#7aa7ff; --accent2:#71f5c6; --ring:rgba(122,167,255,.35);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(122,167,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 15%, rgba(113,245,198,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    .container{width:min(1100px, 92vw);margin:0 auto;padding:28px 0 60px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;opacity:.95;}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);border-radius:999px;font-size:13px;color:var(--muted);}
    .dot{width:8px;height:8px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));box-shadow:0 0 0 4px rgba(122,167,255,.15);}
    .hero{background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .heroInner{padding:26px 26px 18px;display:grid;gap:10px;}
    h1{margin:0;font-size: clamp(28px, 3vw, 42px);letter-spacing:-.02em;}
    .intro{margin:0;color:var(--muted);font-size:15.5px;max-width:75ch;}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:18px;margin-top:18px;}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .cardHeader{padding:16px 16px 0;display:flex;justify-content:space-between;align-items:flex-end;gap:12px;}
    .cardTitle{margin:0;font-size:16px;letter-spacing:.01em;}
    .cardHint{margin:0;color:var(--muted);font-size:12.5px;}
    .cardBody{padding:16px}
    .gallery{display:grid;grid-template-columns: 1.4fr 1fr;gap:10px;}
    .gallery .imgWrap{position:relative;border-radius: 14px;overflow:hidden;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);aspect-ratio: 16/10;}
    .gallery .imgWrap.tall{aspect-ratio: 16/21;grid-row: span 2;}
    .gallery img{width:100%;height:100%;object-fit:cover;display:block;filter: saturate(1.05) contrast(1.05);transform: scale(1.02);}
    .imgCaption{position:absolute;left:10px; right:10px; bottom:10px;padding:8px 10px;border-radius: 12px;
      background: rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.10);font-size:12.5px;color: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);}
    .list{display:flex;flex-direction:column;gap:10px;}
    .item{padding:12px;border-radius: 14px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.14);
      transition: transform .15s ease, border-color .15s ease;cursor:pointer;outline:none;}
    .item:hover{transform: translateY(-1px);border-color: rgba(122,167,255,.35);box-shadow: 0 0 0 4px var(--ring);}
    .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .itemName{margin:0;font-size:14.5px;font-weight:650;}
    .coords{font-size:12px;color: var(--muted);white-space:nowrap;}
    .itemDesc{margin:6px 0 0;font-size:13.5px;color: rgba(238,243,255,.9);opacity:.92;}
    #map{width:100%;height: 460px;border-radius: var(--radius);border:1px solid rgba(255,255,255,.10);overflow:hidden;}
    @media (max-width: 900px){#map{height: 420px}}
    .footer{margin-top:18px;color: var(--muted);font-size:12.5px;opacity:.9;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);}

    .leaflet-container{background:#0a1224;font-family:inherit;}
    .leaflet-popup-content-wrapper{background: rgba(18,27,47,.96);color: var(--text);border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;box-shadow: var(--shadow);}
    .leaflet-popup-tip{background: rgba(18,27,47,.96)}
    .leaflet-control-zoom a{background: rgba(18,27,47,.85);color: var(--text);border:1px solid rgba(255,255,255,.12);}
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="badge"><span class="dot"></span> Auto-generated travel page</div>
      <div class="badge" id="metaBadge">Run: {{RUN_ID}}</div>
    </div>

    <section class="hero">
      <div class="heroInner">
        <h1 id="title">{{TITLE}}</h1>
        <p class="intro" id="intro">{{INTRO}}</p>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="cardHeader">
          <div>
            <p class="cardTitle">Photos</p>
            <p class="cardHint">At least 3 images</p>
          </div>
        </div>
        <div class="cardBody">
          <div class="gallery" id="gallery"></div>
        </div>
      </section>

      <section class="card">
        <div class="cardHeader">
          <div>
            <p class="cardTitle">Attractions</p>
            <p class="cardHint">Click an item to zoom on the map</p>
          </div>
          <div class="pill" id="countPill">0</div>
        </div>
        <div class="cardBody">
          <div class="list" id="attractionsList"></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px;">
      <div class="cardHeader">
        <div>
          <p class="cardTitle">Map</p>
          <p class="cardHint">Markers show attraction coordinates</p>
        </div>
      </div>
      <div class="cardBody">
        <div id="map"></div>
      </div>
    </section>

    <div class="footer">
      <div class="pill" id="footerLeft">Location: {{LOCATION}}</div>
      <div class="pill" id="footerRight">Leaflet + OpenStreetMap</div>
    </div>
  </div>

  <script>
    /**
     * n8n should replace the placeholders below with valid JSON strings.
     * - {{IMAGES_JSON}} must be a JSON array of strings: ["url1","url2","url3"]
     * - {{ATTRACTIONS_JSON}} must be a JSON array of objects: [{name,description,lat,lon}, ...]
     */
    const pageData = {
      title: "{{TITLE}}",
      intro: "{{INTRO}}",
      images: {{IMAGES_JSON}},
      attractions: {{ATTRACTIONS_JSON}}
    };

    function safeText(v, fallback="") {
      return (typeof v === "string" && v.trim()) ? v.trim() : fallback;
    }

    function normalizeData(data) {
      const title = safeText(data?.title, "Discover a new place");
      const intro = safeText(data?.intro, "Here are some recommended attractions and a map.");

      let images = Array.isArray(data?.images) ? data.images.filter(Boolean) : [];
      while (images.length < 3) {
        const q = encodeURIComponent(title.replace(/^Discover\s+/i, ""));
        images.push(`https://source.unsplash.com/featured/?${q}&sig=${images.length + 1}`);
      }
      images = images.slice(0, 3);

      const attractions = Array.isArray(data?.attractions) ? data.attractions : [];
      const cleanedAttractions = attractions
        .map((a) => ({
          name: safeText(a?.name, "Attraction"),
          description: safeText(a?.description, ""),
          lat: Number(a?.lat),
          lon: Number(a?.lon),
        }))
        .filter((a) => Number.isFinite(a.lat) && Number.isFinite(a.lon));

      return { title, intro, images, attractions: cleanedAttractions };
    }

    function averageCenter(attractions) {
      if (!attractions.length) return { lat: 0, lon: 0 };
      const sum = attractions.reduce((acc, a) => (acc.lat += a.lat, acc.lon += a.lon, acc), { lat: 0, lon: 0 });
      return { lat: sum.lat / attractions.length, lon: sum.lon / attractions.length };
    }

    const data = normalizeData(pageData);

    document.getElementById("title").textContent = data.title;
    document.getElementById("intro").textContent = data.intro;
    document.getElementById("countPill").textContent = `${data.attractions.length} places`;
    document.getElementById("footerLeft").textContent = `Images: ${data.images.length} • Attractions: ${data.attractions.length}`;

    // Gallery
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";
    const [img1, img2, img3] = data.images;

    const galleryItems = [
      { url: img1, cls: "imgWrap tall", caption: "Highlights" },
      { url: img2, cls: "imgWrap", caption: "City vibes" },
      { url: img3, cls: "imgWrap", caption: "Top views" },
    ];

    galleryItems.forEach((it) => {
      const wrap = document.createElement("div");
      wrap.className = it.cls;
      wrap.innerHTML = `
        <img src="${it.url}" alt="Location image" loading="lazy" />
        <div class="imgCaption">${it.caption}</div>
      `;
      gallery.appendChild(wrap);
    });

    // Attractions list + map
    const list = document.getElementById("attractionsList");
    list.innerHTML = "";

    window.addEventListener("load", () => {
      const center = averageCenter(data.attractions);
      const startLat = Number.isFinite(center.lat) ? center.lat : 0;
      const startLon = Number.isFinite(center.lon) ? center.lon : 0;

      const map = L.map("map", { zoomControl: true }).setView([startLat, startLon], data.attractions.length ? 13 : 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const bounds = [];

      data.attractions.forEach((a, idx) => {
        const marker = L.marker([a.lat, a.lon]).addTo(map);
        marker.bindPopup(`<b>${a.name}</b><br/>${a.description || ""}`);
        bounds.push([a.lat, a.lon]);

        const item = document.createElement("div");
        item.className = "item";
        item.tabIndex = 0;
        item.innerHTML = `
          <div class="itemTop">
            <p class="itemName">${idx + 1}. ${a.name}</p>
            <span class="coords">${a.lat.toFixed(4)}, ${a.lon.toFixed(4)}</span>
          </div>
          ${a.description ? `<p class="itemDesc">${a.description}</p>` : ""}
        `;

        const focus = () => {
          map.setView([a.lat, a.lon], 15, { animate: true });
          marker.openPopup();
        };

        item.addEventListener("click", focus);
        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); focus(); }
        });

        list.appendChild(item);
      });

      if (bounds.length >= 2) map.fitBounds(bounds, { padding: [20, 20] });

      document.getElementById("metaBadge").textContent = "Rendered ✓";
    });
  </script>
</body>
</html>
